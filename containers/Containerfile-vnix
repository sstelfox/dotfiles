ARG NIX_OS_VERSION

FROM docker.io/nixos/nix:${NIX_OS_VERSION}

ADD ./vnix/nix.conf /etc/nix/nix.conf

RUN mkdir -p /workspace && chmod 755 /workspace

RUN echo "nixuser:x:10001:10001:nixuser:/home/nixuser:/bin/sh" >> /etc/passwd && \
    echo "nixuser:x:10001:" >> /etc/group && \
    mkdir -p /home/nixuser && \
    chown -R nixuser:nixuser /home/nixuser /workspace

VOLUME /nix

WORKDIR /workspace

#USER nixuser

# Don't set until we drop into this user
#ENV HOME=/home/nixuser

# TODO: Doesn't yet exist
#ENV NIX_PATH=/nix/var/nix/profiles/per-user/nixuser/channels

# TODO: Need to link this profile
#ENV PATH=/home/nixuser/.nix-profile/bin:/nix/var/nix/profiles/default/bin:/nix/var/nix/profiles/default/sbin:/bin:/sbin:/usr/bin:/usr/sbin

# TODO: Only need while we're dropping to root or having bad UID mappings...
RUN git config --global --add safe.directory /workspace
