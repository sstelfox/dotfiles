#!/usr/bin/env sh

set -o errexit
set -o pipefail

NIX_OS_VERSION="2.26.1"

CONTAINER_BUILD_ROOT="${HOME}/.dotfiles/containers"
CONTAINER_FILE="${CONTAINER_BUILD_ROOT}/Containerfile-vnix"
CONTAINER_TAG="stelfox.net/containers/vnix:${NIX_OS_VERSION}"

NIX_CACHE="${HOME}/.cache/vnix"

WORKING_DIR="$(pwd)"

build_container() {
  container_hash="$(sha256sum "${CONTAINER_FILE}" | cut -d' ' -f1)"
  hash_file="${NIX_CACHE}/container.hash"

  if [ -f "${hash_file}" ] && [ "$(cat "${hash_file}")" == "${container_hash}" ]; then
    if podman image exists "${CONTAINER_TAG}"; then
      return 0
    fi
  fi

  podman build --build-arg NIX_OS_VERSION=${NIX_OS_VERSION} \
    -t "${CONTAINER_TAG}" -f "${CONTAINER_FILE}" "${CONTAINER_BUILD_ROOT}"

  mkdir -p "${NIX_CACHE}"
  echo -n "${container_hash}" >"${hash_file}"
}

check_dependencies() {
  if ! command -v podman >/dev/null 2>&1; then
    echo "error: must have podman installed" >&2
    return 1
  fi

  return 0
}

initialize_nix_cache() {
  if [ ! -d "${NIX_CACHE}/store" ]; then
    mkdir -p "${NIX_CACHE}"

    podman create --name vnix-init nixos/nix:${NIX_OS_VERSION}
    podman export vnix-init | tar -xf - --strip-components=1 -C "${NIX_CACHE}" nix
    podman rm vnix-init
  fi

  return 0
}

check_dependencies

build_container
initialize_nix_cache

# We're rootless so need to map initial intermediate ID to the user but maybe this needs to be root?
# --uidmap 0:10001:1 --gidmap 0:10001:1 \

exec podman run -it --rm --userns=keep-id \
  --volume "${NIX_CACHE}":/nix:z --volume "${WORKING_DIR}:/workspace" \
  "${CONTAINER_TAG}" $@
